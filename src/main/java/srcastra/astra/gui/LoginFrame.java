/*


 * LoginFrame.java


 *

 * Created on 10 avril 2002, 17:26

 */
package srcastra.astra.gui;

import java.sql.*;
import java.awt.Point;
import java.awt.Dimension;
import javax.swing.JOptionPane;

import srcastra.astra.sys.classetransfert.*;
import srcastra.astra.gui.sys.ErreurScreenLibrary;
import srcastra.astra.sys.classetransfert.configuration.*;

import java.util.*;
import java.awt.*;

import srcastra.astra.gui.sys.*;

/**
 * @author Sébastien
 */


public class LoginFrame extends javax.swing.JDialog implements srcastra.astra.gui.components.userIcon.UserIconBridge {
    /**
     * Creates new form LoginFrame
     */
    String version = "1.13";
    boolean init;
    MainFrame frame;
    private String local = "0";
    private String db;

    public LoginFrame(java.awt.Frame parent, boolean modal, srcastra.astra.sys.rmi.astrainterface serveur, java.util.Locale locale, boolean init, MainFrame frame, String version, String local, String db) {
        this(parent, modal, serveur, locale, init, frame, version);
        this.local = local;
        this.db = db;

    }

    public LoginFrame(java.awt.Frame parent, boolean modal, srcastra.astra.sys.rmi.astrainterface serveur, java.util.Locale locale, boolean init, MainFrame frame, String version) {
        super(parent, modal);
        this.init = init;
        this.frame = frame;
        System.setProperty("sun.java2d.debugfonts", "true");
        Enumeration enu = System.getProperties().propertyNames();
        while (enu.hasMoreElements()) {
            Object tmp = enu.nextElement();
            System.out.println("propriete " + tmp.toString());
            System.out.println("value" + System.getProperty(tmp.toString()));
        }

        this.serveur = serveur;
        this.locale = locale;
        initComponents();
        this.grp_label_Titre.setText(grp_label_Titre.getText() + " " + version);
        setSize(460, 350);
        this.setLocation(getCenterPosition());
        // rempli le tableau des users
        try {

            setLoginUser_T(serveur.returnusers(1));
            displayUserIcon();

        } catch (java.rmi.RemoteException re) {
            ErreurScreenLibrary.displayErreur(this, ErreurScreenLibrary.REMOTE_EXCEPTION, srcastra.astra.Astra.DEBUG, re);

        }

    }


    /**
     * This method is called from within the constructor to
     * <p/>
     * initialize the form.
     * <p/>
     * WARNING: Do NOT modify this code. The content of this method is
     * <p/>
     * always regenerated by the Form Editor.
     */

    private void initComponents() {
        grp_Pan_MainNorth = new javax.swing.JPanel();
        grp_label_Titre = new javax.swing.JLabel();
        grp_Pan_MainCenter = new javax.swing.JPanel();
        jPanel5 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        grp_Pan_FigurinePan = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jPanel9 = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        grp_Tfield_User = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        grp_Pfield_Password = new javax.swing.JPasswordField();
        jPanel10 = new javax.swing.JPanel();
        jPanel6 = new javax.swing.JPanel();
        jPanel11 = new javax.swing.JPanel();
        grp_But_Stop = new javax.swing.JButton();
        jPanel12 = new javax.swing.JPanel();
        grp_But_Refresh = new javax.swing.JButton();
        grp_But_Login = new javax.swing.JButton();
        grp_Pan_MainSouth = new javax.swing.JPanel();
        addWindowListener(new java.awt.event.WindowAdapter() {

            public void windowClosing(java.awt.event.WindowEvent evt) {
                closeDialog(evt);

            }
        });


        grp_label_Titre.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_label_titre"));
        grp_label_Titre.setForeground(java.awt.Color.black);
        grp_label_Titre.setFont(new java.awt.Font("Tahoma", 1, 12));
        grp_Pan_MainNorth.add(grp_label_Titre);
        getContentPane().add(grp_Pan_MainNorth, java.awt.BorderLayout.NORTH);
        grp_Pan_MainCenter.setLayout(new java.awt.BorderLayout());
        jScrollPane1.setBorder(new javax.swing.border.SoftBevelBorder(javax.swing.border.BevelBorder.LOWERED));
        jScrollPane1.setPreferredSize(new java.awt.Dimension(406, 100));
        grp_Pan_FigurinePan.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));
        grp_Pan_FigurinePan.setBackground(java.awt.Color.white);
        jScrollPane1.setViewportView(grp_Pan_FigurinePan);
        jPanel5.add(jScrollPane1);
        grp_Pan_MainCenter.add(jPanel5, java.awt.BorderLayout.NORTH);
        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));
        jPanel8.setPreferredSize(new java.awt.Dimension(300, 100));
        jPanel9.setLayout(new java.awt.GridBagLayout());
        java.awt.GridBagConstraints gridBagConstraints1;
        jLabel2.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_label_login"));
        jLabel2.setToolTipText("");
        jLabel2.setForeground(java.awt.Color.black);
        jLabel2.setFont(new java.awt.Font("Tahoma", 0, 10));
        gridBagConstraints1 = new java.awt.GridBagConstraints();
        gridBagConstraints1.insets = new java.awt.Insets(0, 0, 3, 5);
        gridBagConstraints1.anchor = java.awt.GridBagConstraints.WEST;
        jPanel9.add(jLabel2, gridBagConstraints1);
        grp_Tfield_User.setEditable(false);
        grp_Tfield_User.setFont(new java.awt.Font("Tahoma", 0, 10));
        grp_Tfield_User.setDisabledTextColor(java.awt.Color.black);
        grp_Tfield_User.setPreferredSize(new java.awt.Dimension(200, 21));
        grp_Tfield_User.setMaximumSize(new java.awt.Dimension(200, 21));
        grp_Tfield_User.setMinimumSize(new java.awt.Dimension(200, 21));
        grp_Tfield_User.addCaretListener(new javax.swing.event.CaretListener() {

            public void caretUpdate(javax.swing.event.CaretEvent evt) {
                grp_Tfield_UserCaretUpdate(evt);

            }

        });

        gridBagConstraints1 = new java.awt.GridBagConstraints();
        gridBagConstraints1.insets = new java.awt.Insets(0, 0, 3, 0);
        gridBagConstraints1.anchor = java.awt.GridBagConstraints.NORTHWEST;
        jPanel9.add(grp_Tfield_User, gridBagConstraints1);
        jLabel3.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_label_password"));
        jLabel3.setForeground(java.awt.Color.black);
        jLabel3.setFont(new java.awt.Font("Tahoma", 0, 10));
        gridBagConstraints1 = new java.awt.GridBagConstraints();
        gridBagConstraints1.gridx = 0;
        gridBagConstraints1.gridy = 1;
        gridBagConstraints1.insets = new java.awt.Insets(0, 0, 0, 5);
        gridBagConstraints1.anchor = java.awt.GridBagConstraints.WEST;
        jPanel9.add(jLabel3, gridBagConstraints1);
        grp_Pfield_Password.setFont(new java.awt.Font("Tahoma", 0, 10));
        grp_Pfield_Password.setPreferredSize(new java.awt.Dimension(200, 21));
        grp_Pfield_Password.setMaximumSize(new java.awt.Dimension(200, 21));
        grp_Pfield_Password.setMinimumSize(new java.awt.Dimension(200, 21));
        grp_Pfield_Password.addCaretListener(new javax.swing.event.CaretListener() {

            public void caretUpdate(javax.swing.event.CaretEvent evt) {
                grp_Pfield_PasswordCaretUpdate(evt);

            }

        });
        grp_Pfield_Password.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                grp_Pfield_PasswordKeyPressed(evt);

            }

        });

        gridBagConstraints1 = new java.awt.GridBagConstraints();
        gridBagConstraints1.gridx = 1;
        gridBagConstraints1.gridy = 1;
        gridBagConstraints1.anchor = java.awt.GridBagConstraints.NORTHWEST;
        jPanel9.add(grp_Pfield_Password, gridBagConstraints1);
        jPanel8.add(jPanel9);
        jPanel4.add(jPanel8);
        jPanel10.setPreferredSize(new java.awt.Dimension(100, 100));
        jPanel10.setMinimumSize(new java.awt.Dimension(100, 100));
        jPanel10.setMaximumSize(new java.awt.Dimension(100, 100));
        jPanel4.add(jPanel10);
        grp_Pan_MainCenter.add(jPanel4, java.awt.BorderLayout.CENTER);
        jPanel6.setLayout(new java.awt.GridLayout(1, 0));
        jPanel11.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));
        grp_But_Stop.setFont(new java.awt.Font("Tahoma", 0, 12));
        grp_But_Stop.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_button_stop"));
        grp_But_Stop.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                grp_But_StopActionPerformed(evt);

            }
        });

        jPanel11.add(grp_But_Stop);
        jPanel6.add(jPanel11);
        jPanel12.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));
        grp_But_Refresh.setFont(new java.awt.Font("Tahoma", 0, 12));
        grp_But_Refresh.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_button_refresh"));
        grp_But_Refresh.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                grp_But_RefreshActionPerformed(evt);

            }
        });
        jPanel12.add(grp_But_Refresh);
        grp_But_Login.setFont(new java.awt.Font("Tahoma", 0, 12));
        grp_But_Login.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_button_enter"));
        grp_But_Login.setEnabled(false);
        grp_But_Login.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                grp_But_LoginActionPerformed(evt);

            }

        });

        jPanel12.add(grp_But_Login);
        jPanel6.add(jPanel12);
        grp_Pan_MainCenter.add(jPanel6, java.awt.BorderLayout.SOUTH);
        getContentPane().add(grp_Pan_MainCenter, java.awt.BorderLayout.CENTER);
        getContentPane().add(grp_Pan_MainSouth, java.awt.BorderLayout.SOUTH);
        pack();

    }


    private void grp_Pfield_PasswordKeyPressed(java.awt.event.KeyEvent evt) {

        if (evt.getKeyCode() == java.awt.event.KeyEvent.VK_ENTER) {
            grp_But_LoginActionPerformed(null);

        }

    }

    private void grp_But_StopActionPerformed(java.awt.event.ActionEvent evt) {

        displayStopAdvice();

    }

    private void grp_But_RefreshActionPerformed(java.awt.event.ActionEvent evt) {
        refreshFields();

    }


    private void log() {
        try {

            String jdbcDriverClassName = "org.gjt.mm.mysql.Driver";

            if (jdbcDriverClassName != null)

                Class.forName(jdbcDriverClassName);
            String url = "";
            if (local.equals("1")) {
                url = "jdbc:mysql://" + this.db + ":3306/AstraConnect";
            } else {
                url = "jdbc:mysql://ns3093828.ovh.net:3306/AstraConnect";
            }


            String user = "agence";
            String password = "keyagence3164978520";
            String actif = "";
            Connection con = null;
            boolean oki = false;
            try {
                con = DriverManager.getConnection(url, user, password);
                oki = true;
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                if (!oki) {
                    //url="jdbc:mysql://192.168.1.63:3306/AstraConnect";
                    System.out.println("je passe par ici");
                    try {
                        url = "jdbc:mysql://ooohtml.dyndns.org:3306/astraConnect";


                        con = DriverManager.getConnection(url, user, password);
                    } catch (Exception e) {
                        e.printStackTrace();
                        JOptionPane.showMessageDialog(null, "Error param connection");
                        System.exit(0);
                    }
                }

                srcastra.astra.sys.rmi.utils.Systeminfo system = new srcastra.astra.sys.rmi.utils.Systeminfo();
                ArrayList entite = serveur.renvEntiteRmiObject(currentUser.getUrcleunik()).getList(currentUser.getUrcleunik(), 0);

                String eenom = "";

                for (int i = 0; i < entite.size(); i++) {
                    Entite t = (Entite) entite.get(i);
                    if (t.getEecleunik() == currentUser.getUreecleunik())
                        eenom = t.getEenom();
                }

                /*System.out.println(system.getUsername());
                System.out.println(system.getIpadresse());
                System.out.println(system.getOsname());
                System.out.println(system.getJvmversion());*/

                //loginUser_T.length

                //System.out.println(currentUser.getUrlogin());


                String requ = "insert into LogAstra(Agence,UserAstra,Ip,Versionjava,NomMachine,Quand,ConnectionDeconnection,VersionClientAstra,session,VersionWindows) values (?,?,?,?,?,NOW(),1,?,?,?)";

                PreparedStatement pstmt;

                pstmt = con.prepareStatement(requ);

                pstmt.setString(1, eenom);
                pstmt.setString(2, currentUser.getUrlogin());
                pstmt.setString(3, system.getIpadresse());
                pstmt.setString(4, system.getJvmversion());
                pstmt.setString(5, system.getUsername());
                pstmt.setString(6, "1.55");
                pstmt.setString(7, currentUser.getUrlogin() + Integer.toString(currentUser.getUrcleunik()));
                pstmt.setString(8, system.getOsversion() + "/" + system.getOsname());
                System.out.println(currentUser.getUrsecleunik());
                // currentUser.setTmpString
                System.out.println(currentUser.getUrcleunik());

                pstmt.execute();


                pstmt.close();


                con.close();


            }
        } catch (Exception e) {
            e.printStackTrace();

        }

    }


    private void grp_But_LoginActionPerformed(java.awt.event.ActionEvent evt) {

        grp_Pfield_Password.setEnabled(false);
        grp_Pfield_Password.updateUI();

        if (!isValidLogin()) {

            javax.swing.JOptionPane.showMessageDialog(this, java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_Error_InvalidLogin"),

                    java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_Error_Titre"),

                    javax.swing.JOptionPane.WARNING_MESSAGE);

            refreshFields();

            grp_Pfield_Password.setEnabled(true);

            grp_Pfield_Password.updateUI();

        } else {

            log();
            //java.util.Date d=new java.util.Date();
            //system.
            //System.out.println(system.)
            closeDialog();

        }

    }

    private void grp_Pfield_PasswordCaretUpdate(javax.swing.event.CaretEvent evt) {

        checkFields();

    }

    private void grp_Tfield_UserCaretUpdate(javax.swing.event.CaretEvent evt) {
        checkFields();

    }

    /**
     * Closes the dialog
     */


    private void closeDialog(java.awt.event.WindowEvent evt) {


        if (init) {

            displayStopAdvice();

            this.setVisible(true);

        } else {

            setVisible(false);

            dispose();

        }


    }

    /**
     * @param args the command line arguments
     */


    public static void main(String args[]) {

        new LoginFrame(new javax.swing.JFrame(), true, null, null, true, null, "").show();

    }

    private Point getCenterPosition() {
        Dimension dimProg = this.getSize();
        Dimension dimScreen = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        int Xp = (dimScreen.width - dimProg.width) / 2;
        int Yp = (dimScreen.height - dimProg.height) / 2;
        return new Point(Xp, Yp);


    }

    private String getPassword() {
        char pwdW[] = this.grp_Pfield_Password.getPassword();
        String password = "";
        for (int i = 0; i < pwdW.length; i++) {
            password = password + String.valueOf(pwdW[i]);

        }
        return password;
    }


    private String getUsername() {

        String username = this.grp_Tfield_User.getText();
        return username;

    }

    private void setUsername(String username) {

        this.grp_Tfield_User.setText(username);

    }

    private void refreshFields() {

        this.grp_Tfield_User.setText("");
        this.grp_Pfield_Password.setText("");

    }


    private void displayStopAdvice() {
        int resp = JOptionPane.showConfirmDialog(this, java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_StopAdvice_01"),
                java.util.ResourceBundle.getBundle("srcastra/astra/locale/LoginFrame", locale).getString("LF_StopAdvise_titre"),
                JOptionPane.YES_NO_OPTION, JOptionPane.WARNING_MESSAGE);

        if (resp == JOptionPane.YES_OPTION) {
            System.exit(0);
        } else {

            this.show();

        }

    }

    private void setEnabledLoginButton(boolean enabled) {

        grp_But_Login.setEnabled(enabled);

    }


    private void checkFields() {

        boolean en = false;
        if (!grp_Tfield_User.getText().equals("")) {
            for (int i = 0; i < loginUser_T.length; i++) {
                if (loginUser_T[i].getUrlogin().equals(grp_Tfield_User.getText())) {
                    en = true;
                    break;
                }

            }

        }

        if (grp_Pfield_Password.getPassword().length == 0) {
            en = false;
        }


        setEnabledLoginButton(en);


    }


    /**
     * Indexed getter for property loginUser_T.
     *
     * @param index Index of the property.
     * @return Value of the property at <CODE>index</CODE>.
     */


    public srcastra.astra.sys.classetransfert.Loginusers_T getLoginUser_T(int index) {

        return loginUser_T[index];


    }


    /**
     * Getter for property loginUser_T.
     *
     * @return Value of property loginUser_T.
     */


    public srcastra.astra.sys.classetransfert.Loginusers_T[] getLoginUser_T() {

        return loginUser_T;

    }

    /**
     * Indexed setter for property loginUser_T.
     *
     * @param index       Index of the property.
     * @param loginUser_T New value of the property at <CODE>index</CODE>.
     */


    public void setLoginUser_T(int index, srcastra.astra.sys.classetransfert.Loginusers_T loginUser_T) {
        this.loginUser_T[index] = loginUser_T;

    }


    /**
     * Setter for property loginUser_T.
     *
     * @param loginUser_T New value of property loginUser_T.
     */


    public void setLoginUser_T(srcastra.astra.sys.classetransfert.Loginusers_T[] loginUser_T) {

        this.loginUser_T = loginUser_T;

    }


    private void displayUserIcon() {

        if (loginUser_T.length != 0) {

            for (int i = 0; i < loginUser_T.length; i++) {

                if (loginUser_T[i] != null) {
                    grp_Pan_FigurinePan.add(new srcastra.astra.gui.components.userIcon.UserIcon(this, loginUser_T[i].getUrlogin(), String.valueOf(loginUser_T[i].getUridlogo())));


                }


            }

        }

    }


    public void setUsernameFromUserIcon(String username) {

        this.grp_Tfield_User.setText(username);
        grp_Pfield_Password.requestFocus();


    }


    private void closeDialog() {

        System.out.println("\n[CLOSE DIALOG]\n");

        setVisible(false);

        dispose();

        if (!init) {

            frame.setCurrentUser(currentUser);

        } else {

            javax.swing.JFrame frame = new MainFrame(serveur, currentUser);
            LoadData ld = new LoadData(frame, false, this.serveur, this.currentUser);
            ld.setVisible(true);
            ld.show();
            new LoginFrame.LoadData_tr(ld, frame).start();

        }

    }


    public class LoadData_tr extends Thread {
        private LoadData ld;
        private javax.swing.JFrame frame;

        public LoadData_tr(LoadData ld, javax.swing.JFrame frame) {

            this.ld = ld;
            this.frame = frame;

        }


        public void run() {

            System.out.println("\n[RUN]\n");
            ld.chargedata();
            ld.dispose();
            frame.show();

        }

    }


    private boolean isValidLogin() {

        int lu_index = -1;

        Loginusers_T tmpgestion = null;

        // recherche du user equivalent au text du JText dans le tableau des users

        for (int i = 0; i < loginUser_T.length; i++) {

            if (loginUser_T[i].getUrlogin().equals(grp_Tfield_User.getText())) {
//loginUser_T[i].g
                lu_index = i;

                break;

            }

        }

        if (lu_index < 0) {

            return false;

        } else {

            loginUser_T[lu_index].setUrpassword(getPassword());

            srcastra.astra.sys.rmi.utils.Systeminfo test = new srcastra.astra.sys.rmi.utils.Systeminfo();

            Userinfo_T infodistante = new Userinfo_T(test.getOsname(), test.getOsversion(), test.getJvmversion(), test.getUsername(), test.getIpadresse());

            try {

                tmpgestion = serveur.userautorisation(loginUser_T[lu_index], infodistante);

                String versions = serveur.getVersion();

                if (!version.equals(versions)) {

                    new MessageManager().showMessageDialog(null, "version", "version_title", tmpgestion);

                    System.exit(0);

                }

                Locale.setDefault(tmpgestion.getLangage());

            } catch (srcastra.astra.sys.rmi.Exception.AuthorizationFailedException afe) {

                return false;

            } catch (java.rmi.RemoteException re) {

                ErreurScreenLibrary.displayErreur(this, ErreurScreenLibrary.REMOTE_EXCEPTION, srcastra.astra.Astra.DEBUG, re);

                return false;


            }


        }


        this.currentUser = tmpgestion;
        return true;

    }


    /**
     * Getter for property frame.
     *
     * @return Value of property frame.
     */

    public srcastra.astra.gui.MainFrame getFrame() {

        return frame;

    }


    /**
     * Setter for property frame.
     *
     * @param frame New value of property frame.
     */

    public void setFrame(srcastra.astra.gui.MainFrame frame) {

        this.frame = frame;

    }


    private srcastra.astra.sys.classetransfert.Loginusers_T[] loginUser_T;


    public srcastra.astra.sys.rmi.astrainterface serveur;


    private String session;


    private java.util.Locale locale;


    private srcastra.astra.sys.classetransfert.Loginusers_T currentUser;

    // Variables declaration - do not modify


    private javax.swing.JPanel grp_Pan_MainNorth;


    private javax.swing.JLabel grp_label_Titre;


    private javax.swing.JPanel grp_Pan_MainCenter;


    private javax.swing.JPanel jPanel5;


    private javax.swing.JScrollPane jScrollPane1;


    private javax.swing.JPanel grp_Pan_FigurinePan;


    private javax.swing.JPanel jPanel4;


    private javax.swing.JPanel jPanel8;


    private javax.swing.JPanel jPanel9;


    private javax.swing.JLabel jLabel2;
    private javax.swing.JTextField grp_Tfield_User;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JPasswordField grp_Pfield_Password;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JButton grp_But_Stop;
    private javax.swing.JPanel jPanel12;
    private javax.swing.JButton grp_But_Refresh;
    private javax.swing.JButton grp_But_Login;
    private javax.swing.JPanel grp_Pan_MainSouth;

    // End of variables declaration

}


