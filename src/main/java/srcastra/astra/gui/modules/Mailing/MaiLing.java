/*

 * MaiLing.java

 *

 * Created on 10 avril 2003, 11:09

 */



package srcastra.astra.gui.modules.Mailing;

import srcastra.astra.sys.classetransfert.configuration.*;

import srcastra.astra.gui.sys.*;

import srcastra.astra.sys.*;

//import com.java4less.rmail.*;

//import com.java4less.rmime.*;

/**

 *

 * @author  Thomas

 */

public class MaiLing extends javax.swing.JDialog {

    

    /** Creates new form MaiLing */

    MailInterface frame;

    java.awt.Frame parent;

    String filePath;
    
    String from;
    

    public MaiLing(java.awt.Frame parent, boolean modal,MailInterface frame,AbstractConfig_T config) {

        super(parent, modal);

        initComponents();

        grp_TField_smtp.setText(frame.getUser().getEeSmtp());
            
        this.frame=frame;

        this.parent=parent;
        
        
        if(frame.getUser().getUrMailBur().length()!=0)
            this.from=frame.getUser().getUrMailBur();
        else if(frame.getFormEntiteMail().length()!=0)
            this.from=frame.getFormEntiteMail();
        else
            this.from="";
       
        
        for(int i=0;i<frame.getEmailAdres().length;i++){

           String tmp=frame.getEmailAdres()[i];

           Logger.getDefaultLogger().log(Logger.LOG_INFOS,"chaine "+tmp);

           if(tmp.indexOf(".")!=-1 && tmp.indexOf("@")!=-1)

             jComboBox1.addItem(frame.getEmailAdres()[i]);   

        }        

    }

     public MaiLing(java.awt.Frame parent, boolean modal,MailInterface frame,AbstractConfig_T config,String filePath) {

        super(parent, modal);

        this.filePath=filePath;

        initComponents();

        if(filePath!=null)

            grp_Label_Attache.setText(filePath);

        grp_TField_smtp.setText(frame.getUser().getEeSmtp());

        this.frame=frame;

        this.parent=parent;
        

        
             if(frame.getUser().getUrMailBur().length()!=0)
            this.from=frame.getUser().getUrMailBur();
        else if(frame.getFormEntiteMail().length()!=0)
            this.from=frame.getFormEntiteMail();
        else
            this.from="";
       
        
        if(frame.getEmailAdres()[0]=="null")
            jComboBox1.addItem("");  
        else
        jComboBox1.addItem(frame.getEmailAdres()[0]);   
        
         /*   for(int i=0;i<frame.getEmailAdres().length;i++){

               String tmp=frame.getEmailAdres()[i];

               Logger.getDefaultLogger().log(Logger.LOG_INFOS,"chaine "+tmp);
               
               if(tmp!=null){
               if(tmp.indexOf(".")!=-1 && tmp.indexOf("@")!=-1)

                 jComboBox1.addItem(frame.getEmailAdres()[i]);   
             }
            }*/
           
       

    }

    

    /** This method is called from within the constructor to

     * initialize the form.

     * WARNING: Do NOT modify this code. The content of this method is

     * always regenerated by the Form Editor.

     */

    private void initComponents() {//GEN-BEGIN:initComponents
        java.awt.GridBagConstraints gridBagConstraints;

        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        grp_TArea_message = new javax.swing.JTextPane();
        jPanel3 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        grp_TField_object = new javax.swing.JTextField();
        jLabel4 = new javax.swing.JLabel();
        grp_Label_Attache = new javax.swing.JLabel();
        jComboBox1 = new javax.swing.JComboBox();
        jPanel7 = new javax.swing.JPanel();
        jLabel3 = new javax.swing.JLabel();
        grp_TField_smtp = new javax.swing.JTextField();
        jPanel5 = new javax.swing.JPanel();
        jPanel6 = new javax.swing.JPanel();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();

        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosing(java.awt.event.WindowEvent evt) {
                closeDialog(evt);
            }
        });

        jPanel1.setLayout(new java.awt.BorderLayout());

        jPanel2.setLayout(new java.awt.BorderLayout());

        jPanel2.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        jPanel2.setPreferredSize(new java.awt.Dimension(10, 50));
        jScrollPane1.setHorizontalScrollBarPolicy(javax.swing.JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
        jScrollPane1.setPreferredSize(new java.awt.Dimension(580, 220));
        jScrollPane1.setViewportView(grp_TArea_message);

        jPanel2.add(jScrollPane1, java.awt.BorderLayout.CENTER);

        jPanel1.add(jPanel2, java.awt.BorderLayout.CENTER);

        jPanel3.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));

        jPanel3.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        jPanel3.setMinimumSize(new java.awt.Dimension(128, 100));
        jPanel3.setPreferredSize(new java.awt.Dimension(10, 85));
        jPanel4.setLayout(new java.awt.GridBagLayout());

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 10));
        jLabel1.setText("To :");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(3, 0, 2, 3);
        jPanel4.add(jLabel1, gridBagConstraints);

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 10));
        jLabel2.setText("Object :");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(1, 0, 0, 3);
        jPanel4.add(jLabel2, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(0, 0, 2, 0);
        jPanel4.add(grp_TField_object, gridBagConstraints);

        jLabel4.setFont(new java.awt.Font("Tahoma", 1, 10));
        jLabel4.setText("Attachement :");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(1, 0, 0, 3);
        jPanel4.add(jLabel4, gridBagConstraints);

        grp_Label_Attache.setFont(new java.awt.Font("Tahoma", 0, 10));
        grp_Label_Attache.setPreferredSize(new java.awt.Dimension(4, 20));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        jPanel4.add(grp_Label_Attache, gridBagConstraints);

        jComboBox1.setEditable(true);
        jComboBox1.setPreferredSize(new java.awt.Dimension(300, 25));
        jPanel4.add(jComboBox1, new java.awt.GridBagConstraints());

        jPanel3.add(jPanel4);

        jPanel7.setLayout(new java.awt.GridBagLayout());

        jLabel3.setFont(new java.awt.Font("Tahoma", 1, 10));
        jLabel3.setText("SMTP");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.insets = new java.awt.Insets(0, 0, 2, 3);
        jPanel7.add(jLabel3, gridBagConstraints);

        grp_TField_smtp.setText("smtp.xs4all.be");
        grp_TField_smtp.setPreferredSize(new java.awt.Dimension(200, 20));
        grp_TField_smtp.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                grp_TField_smtpActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.insets = new java.awt.Insets(0, 0, 2, 0);
        jPanel7.add(grp_TField_smtp, gridBagConstraints);

        jPanel3.add(jPanel7);

        jPanel1.add(jPanel3, java.awt.BorderLayout.NORTH);

        jPanel5.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        jPanel5.setPreferredSize(new java.awt.Dimension(20, 40));
        jPanel6.setLayout(new java.awt.GridBagLayout());

        jButton1.setFont(new java.awt.Font("Tahoma", 1, 10));
        jButton1.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/generale").getString("Mailing_send"));
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        jPanel6.add(jButton1, new java.awt.GridBagConstraints());

        jButton2.setFont(new java.awt.Font("Tahoma", 1, 10));
        jButton2.setText(java.util.ResourceBundle.getBundle("srcastra/astra/locale/generale").getString("Mailing_cancel"));
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        jPanel6.add(jButton2, new java.awt.GridBagConstraints());

        jPanel5.add(jPanel6);

        jPanel1.add(jPanel5, java.awt.BorderLayout.SOUTH);

        getContentPane().add(jPanel1, java.awt.BorderLayout.CENTER);

        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        setBounds((screenSize.width-650)/2, (screenSize.height-450)/2, 650, 450);
    }//GEN-END:initComponents



    private void grp_TField_smtpActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_grp_TField_smtpActionPerformed

        // Add your handling code here:

    }//GEN-LAST:event_grp_TField_smtpActionPerformed



    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed

        dispose();        // Add your handling code here:

    }//GEN-LAST:event_jButton2ActionPerformed



    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed

     this.setCursor(new java.awt.Cursor(java.awt.Cursor.WAIT_CURSOR));
     
        String to=jComboBox1.getSelectedItem().toString();
     
        if(to.indexOf("@")==-1 || to.indexOf(".")==-1)
            javax.swing.JOptionPane.showMessageDialog(this,"TO mail adress invalid");
        else
        {
        sendMail();

     this.setCursor(new java.awt.Cursor(java.awt.Cursor.DEFAULT_CURSOR));

         dispose();
        }

    }//GEN-LAST:event_jButton1ActionPerformed

    private void sendMail(){

    //  PopServer pop= new PopServer();

        String message="";

        try{

          message="TO : "+jComboBox1.getSelectedItem().toString()+"\n"+"FROM : "+frame.getUser().getUrMailBur()+"\n"+"SMTP : "+grp_TField_smtp.getText();

          if(grp_TField_smtp.getText().equals(""))              

            javax.swing.JOptionPane.showMessageDialog(this,message);

          else{

              if(filePath==null){

                srcastra.astra.sys.Mailing.sendMail2(grp_TField_smtp.getText(), jComboBox1.getSelectedItem().toString(), from, grp_TField_object.getText(), grp_TArea_message.getText(),frame.getUser().getSignature());

              }

              else{

                  srcastra.astra.sys.Mailing.sendMailWithAttachement(grp_TField_smtp.getText(), jComboBox1.getSelectedItem().toString(), from, grp_TField_object.getText(), grp_TArea_message.getText(),filePath,frame.getUser().getSignature());

              }

              }

          }catch(Exception e){

           if(e instanceof javax.mail.internet.AddressException){

               javax.swing.JOptionPane.showMessageDialog(this,message);

           }

           e.printStackTrace();   

        }

          /* MailMsg m;

	  MailMsgPart p=new MailMsgPart();

  

	  // HOW TO SEND AN E-MAIL

	  m=new MailMsg();

	  m.from="hykiukira@hotmail.com";

	  m.addRecipient(jComboBox1.getSelectedItem().toString());

	  m.subject=grp_TField_object.getText();

	  

	  //create body

	  p.setData(grp_TArea_message.getText(),MimeEncoder.QUOTED);

	  m.addPart(p);

	 // m.addFile(new java.io.File("d:\\mydocument.doc"));



      /** for smtp authentication

      m.authUser="user";

      m.authPwd="pwd";

      m.autMethod=m.AUTH_LOGIN;//  or m.AUTH_PLAIN

         

            

	  m.smtpServer=grp_TField_smtp.getText();

         // m.

          double t1=System.currentTimeMillis();

	  m.mail();

          double t2=System.currentTimeMillis();

          double t3=(t2-t1)/1000;

          System.out.println("temps de l'envoi du mail en seconde "+t3);

	  

	  // HOW TO RECEIVE 

	  

/*	  pop.connect("pop.mycompany.com","user","psw");

	  for (int i=1;i<=pop.msgs;i++) {

		   m=pop.retrieveMsg(i);

		   pop.deleteMsg(i);

		   

		   // do here something with the message m

	  }

	  pop.disconnect();*/

	     

    }

    /** Closes the dialog */

    private void closeDialog(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_closeDialog

        setVisible(false);

        dispose();

    }//GEN-LAST:event_closeDialog

    

    /**

     * @param args the command line arguments

     */

    public static void main(String args[]) {

      //  new MaiLing(new javax.swing.JFrame(), true).show();

    }

    public void show(){     
    
     if (from.length()==0)
     {
       new MessageManager().showMessageDialog(this,"Mail1","Mail_title1",frame.getUser());

            dispose();  
         
     }
     
     else
         
     if(jComboBox1.getItemCount()==0) { // || (frame.getUser().getUrMailBur().length()==0 && frame.getFormEntiteMail().length()==0){
         

            new MessageManager().showMessageDialog(this,"Mail","Mail_title",frame.getUser());

            dispose();

        }

     else

         super.show();

    }

    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel grp_Label_Attache;
    private javax.swing.JTextPane grp_TArea_message;
    private javax.swing.JTextField grp_TField_object;
    private javax.swing.JTextField grp_TField_smtp;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JComboBox jComboBox1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JScrollPane jScrollPane1;
    // End of variables declaration//GEN-END:variables

    

}

